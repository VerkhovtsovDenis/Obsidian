В данном документе описывается эксплуатация **уязвимости Local File Inclusion (LFI)** на веб-сервере, работающем на Windows, и последующее использование этой уязвимости для кражи хэша NetNTLMv2 с помощью инструмента **Responder**. Затем хэш взламывается с помощью **John the Ripper**, что позволяет получить доступ к системе через WinRM.

### Основные этапы эксплуатации уязвимости:

1. **Обнаружение уязвимости Local File Inclusion (LFI)**:
    
    - Веб-сервер использует параметр `page` для загрузки различных страниц (например, `french.html`). Этот параметр не проверяется должным образом, что позволяет злоумышленнику использовать **путь к файлу** для включения локальных файлов с сервера.
        
    - Злоумышленник использует директиву `../../../../../../../../../../windows/system32/drivers/etc/hosts` для чтения системного файла `hosts`, что подтверждает наличие уязвимости LFI.
        
2. **Эксплуатация LFI для кражи NetNTLMv2 хэша**:
    
    - Поскольку сервер работает на Windows, злоумышленник использует возможность загрузки файлов через **SMB** (Server Message Block). Это позволяет заставить сервер аутентифицироваться на атакующей машине.
        
    - Используя инструмент **Responder**, злоумышленник создает поддельный SMB-сервер, который перехватывает запросы аутентификации от целевого сервера. В результате перехватывается хэш NetNTLMv2 для пользователя **Administrator**.
        
3. **Взлом хэша NetNTLMv2**:
    
    - Перехваченный хэш NetNTLMv2 сохраняется в файл и передается в **John the Ripper** для подбора пароля.
        
    - Используя словарь `rockyou.txt`, злоумышленник успешно взламывает хэш и получает пароль для учетной записи **Administrator** — `badminton`.
        
4. **Получение доступа через WinRM**:
    
    - С помощью инструмента **Evil-WinRM** злоумышленник подключается к серверу через WinRM (Windows Remote Management), используя украденные учетные данные.
        
    - После успешного подключения злоумышленник получает доступ к системе и находит флаг в директории `c:\users\mike\Desktop\flag.txt`.
        

### Уязвимости, которые были использованы:

1. **Local File Inclusion (LFI)**:
    
    - Веб-сервер не проверяет и не санирует входные данные в параметре `page`, что позволяет злоумышленнику включать локальные файлы с сервера. Это классическая уязвимость, возникающая из-за недостаточной проверки пользовательского ввода.
        
2. **Небезопасная конфигурация SMB**:
    
    - Сервер пытается аутентифицироваться на поддельном SMB-сервере, что позволяет злоумышленнику перехватить хэш NetNTLMv2. Это возможно из-за того, что Windows по умолчанию пытается аутентифицироваться через NTLM, если не настроены более безопасные методы.
        
3. **Слабый пароль**:
    
    - Пароль для учетной записи **Administrator** был слабым и содержался в словаре `rockyou.txt`, что позволило быстро взломать хэш.
        

### Рекомендации по устранению уязвимостей:

1. **Исправление уязвимости LFI**:
    
    - Проверять и санировать все пользовательские входные данные, особенно те, которые используются для включения файлов.
        
    - Использовать белые списки допустимых значений для параметров, таких как `page`.
        
2. **Усиление аутентификации**:
    
    - Отключить NTLM и использовать более безопасные протоколы аутентификации, такие как Kerberos.
        
    - Настроить политики безопасности для предотвращения аутентификации на непроверенных SMB-серверах.
        
3. **Усиление паролей**:
    
    - Использовать сложные пароли, которые не содержатся в общедоступных словарях.
        
    - Регулярно менять пароли и использовать многофакторную аутентификацию.
        
4. **Мониторинг и аудит**:
    
    - Регулярно проверять журналы событий на предмет подозрительных попыток аутентификации.
        
    - Использовать системы обнаружения вторжений (IDS) для выявления атак, связанных с перехватом хэшей.
        

Таким образом, основная уязвимость, которую эксплуатировали, — это **Local File Inclusion (LFI)**, которая позволила злоумышленнику перехватить хэш NetNTLMv2 и получить доступ к системе через WinRM.