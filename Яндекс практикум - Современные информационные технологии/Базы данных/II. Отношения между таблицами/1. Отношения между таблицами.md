# Отношения между таблицами

Превратим таблицу с перечнем фильмов в полноценную и гибкую базу данных; добавим в базу дополнительную информацию и изменим архитектуру — создадим в базе несколько связанных таблиц. На примере этой конструкции познакомимся с одной из основных идей реляционных баз — со связями между таблицами.

## Данные

Вот какая информация о фильме будет храниться в базе:

- Название (русское) — единственное.
- Оригинальное название — единственное.
- Тип фильма — один из списка: мультфильм, сериал, мультсериал или фильм.
- Режиссёр — может быть один, а может быть и несколько.

Первым делом создадим в базе таблицы для этих данных. Кроме полей с информацией, в каждой таблице будет поле с уникальным идентификатором записи — колонка `id`.

### Таблицы

- Таблица **video_products**. В ней будут храниться русские названия фильмов и ссылки на записи из других таблиц.
- Таблица **original_titles** (Оригинальные названия) — перечень оригинальных названий фильмов из таблицы **video_products**.
- Таблица **product_types** (Типы) — перечень возможных типов видеопродукции (фильм, мультфильм и другие).
- Таблица **directors** (Режиссёры) — имена режиссёров.

К каждому видеопродукту из таблицы **video_products** должно быть привязано его оригинальное название, тип и режиссёр.

Для привязки данных из других таблиц создадим в таблице **video_products** поля, в которых будем хранить `id` связанной записи из таблиц **original_titles**, **product_types** и **directors.**

![](https://pictures.s3.yandex.net/resources/S2_138_1682533388.png)

В таблице **video_products** в полях `original_title_id`, `type_id` и `director_id` указаны `id` соответствующих записей в других таблицах.

Названия полей, ссылающихся на другие таблицы, могут быть любыми, но лучше составлять их по принципу `имяТаблицы_имяПоля`.

В остальных таблицах будет храниться такая информация:

![](https://pictures.s3.yandex.net/resources/S2_139_1682533402.png)

![](https://pictures.s3.yandex.net/resources/S2_140_1682533413.png)

![](https://pictures.s3.yandex.net/resources/S2_141_1682533425.png)

Для сериала «Она написала убийство» связи с другими таблицами будут выглядеть так:

![](https://pictures.s3.yandex.net/resources/S02_218_1678064656.png)

Зная связанные с записью идентификаторы из других таблиц, можно по цепочке извлечь дополнительные данные и получить полную информацию о сериале:

- **Русское название:** _Она написала убийство_
- **Оригинальное название:** _Murder, She Wrote_
- **Тип:** _Сериал_
- **Режиссёр:** _Кори Аллен, Энтони Пуллен Шоу, Ричард Левинсон_

Записи в таблицах будут связаны по-разному:

- У каждого фильма есть лишь одно оригинальное название, значит, два разных фильма не могут быть связаны с одной и той же записью в таблице **original_titles.**
    
    _Один фильм — одно оригинальное название._
    
- Разные фильмы из таблицы **video_products** могут быть связаны с одной и той же записью в таблице **product_types.** Например, «Безумные мелодии Луни Тюнз» и «Весёлые мелодии» ссылаются на запись с идентификатором 2; обе эти ленты — мультсериалы.
    
    _Несколько фильмов — один тип._
    
- Есть ещё один вариант: у одного фильма может быть несколько режиссёров, то есть один фильм может быть связан с несколькими записями из таблицы **directors** (как, например, _Она написала убийство)_; режиссёр может снять несколько фильмов (как Текс Эйвери в нашей базе).
    
    _Несколько режиссёров — один фильм_ и _несколько фильмов — один режиссёр._
    

Всё это — различные **типы связей**.

## Связи между таблицами

В реляционных базах данных может быть три типа связей:

- Один к одному (1:1 или _one-to-one_): фильм → оригинальное название.
- Многие к одному (M:1 или _many-to-one_): фильмы → тип.
- Многие ко многим (N:M или _many-to-many_): фильмы → режиссёры.

Чтобы настроить эти связи — в каждой из таблиц должен быть _primary key_ (**PK**, идентификатор записи; его значение должно быть уникально в пределах таблицы), а в таблицах, которые ссылаются на другие таблицы, понадобятся поля с внешними ключами (**FK**, _foreign key_), где будет указано, куда ссылается каждая конкретная запись.


![[Pasted image 20250124181739.png]]
Чем отличаются первичный и внешний ключи?

Внешний ключ должен быть уникальным; это позволяет точно идентифицировать записи в таблице. Первичный ключ отвечает за связь между таблицами и может повторяться.

Как раз наоборот! В определении перепутаны первичный и внешний ключи.

Тоже правильный ответ

Внешний ключ отвечает за связи между таблицами и может повторяться в таблице. Первичный ключ должен быть уникален в пределах таблицы: он идентифицирует запись в и позволяет другим записям установить с ней связь.

Неправильный ответ

Между ними нет разницы.

Разница есть, иначе не стали бы придумывать две разные сущности.

Внешний ключ даёт доступ к отдельной таблице, а первичный — ко всей базе данных.

Первичный и внешний ключи — это не про доступы к таблицам, а про уникальность записей в таблице. Первичный ключ отвечает за уникальность записи в таблице, а внешний — указывает на определённую запись таблицы, как адрес на конверте указывает на определённый дом или квартиру.

## Связь «один к одному» (1:1)

В жизни отношения _один к одному_ довольно часты:

- **Сотрудник** **— паспорт.** У любого сотрудника компании обязательно есть паспорт (людей без паспорта отдел кадров просто не может взять на работу). И паспорт у сотрудника только один. В базе данных у кадровиков между таблицами **staff** и **passports** должна быть установлена связь 1:1.
- **Сотрудник — водительское удостоверение.** У сотрудника компании может быть только одно водительское удостоверение (но его может и не быть).

### Один к одному: обязательная связь

Для хранения информации о сотрудниках и их паспортах можно создать таблицы **staff** и **passports** и организовать между ними **обязательную** связь «один к одному»: в поле `passport_id` не может стоять `NULL`.

![](https://pictures.s3.yandex.net/resources/S2_142_1682533456.png)

![](https://pictures.s3.yandex.net/resources/S2_143_1682533469.png)

![](https://pictures.s3.yandex.net/resources/S02_219_1678064810.png)

### Один к одному: необязательная связь

Между таблицами можно установить **необязательную** связь «один к одному». Например, отдел кадров ведёт учёт не только паспортов, но и автомобильных удостоверений своих сотрудников. Данные об удостоверениях можно хранить в таблице **driving_licenses**. У одного сотрудника может быть только одно водительское удостоверение.

Но у кого-то может и не быть водительского удостоверения. Значит, связь между таблицами **staff** и **driving_licenses** — **необязательная**, и в поле `driving_license_id` должно быть разрешено значение `NULL`.

![](https://pictures.s3.yandex.net/resources/S2_144_1682533481.png)

![](https://pictures.s3.yandex.net/resources/S2_145_1682533495.png)

У директора нет водительских прав; возможно, он ездит на такси или на велосипеде.

![](https://pictures.s3.yandex.net/resources/S02_221_1678064831.png)

## Связь «многие к одному» (M:1)

В реляционных БД чаще всего встречается связь «многие к одному». Основная идея этой связи в том, что много сущностей можно связать с одной.

Эта связь описывает, например, такие отношения:

- **Кинотеатр и залы**: в одном кинотеатре может быть много залов. **Множество** залов связаны с **одним** кинотеатром.
- **Место рождения**: в определённом городе может родиться много детей. **Много** детей связаны с **одним** городом.
- **Стоянка и машины**: на одной стоянке может быть много машин. **Много** машин связаны с **одной** парковкой.

### Многие к одному: обязательная связь

В кинотеатре есть хотя бы один зал с экраном — иначе это не кинотеатр. Кинозалов может быть много или он может быть один — но он обязательно есть.

Каждый определённый кинозал обязательно расположен в каком-то кинотеатре, он не может существовать сам по себе. Следовательно, связь **обязательна**: каждая запись таблицы **cinema_halls** должна ссылаться на запись в **cinema**.

![](https://pictures.s3.yandex.net/resources/S2_146_1682533514.png)

![](https://pictures.s3.yandex.net/resources/S2_147_1682533525.png)

![](https://pictures.s3.yandex.net/resources/S02_222_1678064853.png)

В кинотеатре «Люмьер» — залы «Луи» и «Огюст»; в кинотеатре «Фантаскоп» — залы «Готика» и «Классика», а в «Двадцать пятом кадре» — лишь один зал, «Четыре измерения».

### Многие к одному: необязательная связь

Автомобильная стоянка может вмещать множество машин. Но может случиться и так, что автомобиль стоит не на парковке, а, например, на балконе у хозяина; в такой ситуации автомобиль не привязан ни к одной из парковок.

Связь между автомобилем и парковкой — многие к одному, **необязательная**: в поле `parking_id` может быть `NULL`.

![](https://pictures.s3.yandex.net/resources/S2_148_1682533543.png)

![](https://pictures.s3.yandex.net/resources/S2_149_1682533554.png)

![](https://pictures.s3.yandex.net/resources/image_1705302772.png)

Судя по этой базе, парковка “Parking King” — пуста, на “Auto salvage” — две машины, а на «Шаркон» и “Châtillon” — по одной.

При создании обязательных связей 1:1 и M:1 важен порядок, в котором создаются связанные записи. Например, в случае связи «сотрудник — паспорт» сперва должна быть создана запись о паспорте и только после этого — запись о сотруднике: ведь в записи о сотруднике есть обязательное для заполнения поле `passport_id`, но его не удастся заполнить, если в таблице **passport** не создана запись о паспорте сотрудника.

Подобная ситуация возникнет и при обязательной связи M:1 — нельзя создать запись о кинозале, не создав запись о кинотеатре.

## Связь «многие ко многим» (N:M)

Это самый сложный тип связей: нескольким записям из одной таблицы могут соответствовать несколько записей из другой.

- **Учителя и классы.** В школе работают несколько учителей-предметников, каждый из них преподаёт в нескольких классах; каждому классу преподают несколько учителей. Если создать таблицы **teachers** и **classes** — то между ними должна быть установлена связь «многие ко многим».
- **Фильмы — режиссёры.** Каждый режиссёр может снять несколько фильмов. У одного фильма может быть несколько режиссёров.

Как раз на примере фильмов и режиссёров и посмотрим, как работает связь N:M. В нашей базе два фильма связаны с одним режиссёром и один фильм — с тремя режиссёрами.

Таким образом, многие записи каждой из таблиц могут быть связаны с многими записями другой таблицы.

![](https://pictures.s3.yandex.net/resources/S02_224_1685550813.png)

Картинка выразительная, но это лишь упрощённое изображение связи: в одну ячейку FK нельзя записать несколько ссылок.

![](https://pictures.s3.yandex.net/resources/S2_150_1682533571.png)

На уровне базы данных нельзя установить прямую связь N:M между двумя таблицами. Для такой связи необходима **промежуточная таблица**.

Название промежуточной таблицы принято составлять из имён тех таблиц, которые связаны через неё; в нашем случае получилось название **directors__video_products**.

Поля таблицы **directors__video_products**:

- `video_product_id`: ссылка на `id` записи в `video_products`.
- `director_id`: ссылка на `id` записи в таблице `directors`.

Посредством этой таблицы можно связать один фильм с несколькими режиссёрами и одного режиссёра — с несколькими фильмами. Обратившись к этой таблице, можно получить информацию о связях.

При связи «многие ко многим» в связываемых таблицах не нужно поле с внешним ключом; обратите внимание — в таблице **video_products** нет никаких ссылок на таблицу **directors**, а в **directors** нет ссылок на **video_products**.

![](https://pictures.s3.yandex.net/resources/S2_151_1682533597.png)

![](https://pictures.s3.yandex.net/resources/S2_152_1682533616.png)

![](https://pictures.s3.yandex.net/resources/S2_153_1682533633.png)

![](https://pictures.s3.yandex.net/resources/S02_232_1685551077.png)

Связи в таблице **directors__video_products** можно прочитать так:

![](https://pictures.s3.yandex.net/resources/S2_154_1682533645.png)

> При проектировании базы данных важно предусмотреть связи, которые могут потребоваться в дальнейшем. Например, если забыть о том, что у фильма может быть больше одного режиссёра, и создать между фильмом и режиссёром связь «один ко многим» — в ближайшей перспективе придётся изменять базу данных. А если к тому моменту в таблице будет много записей — возникнут сложности.

Выберите соответствующий тип отношений:

Связь N:M
**Путешественники — страны.**
**Читатели — книги.**

Связь 1:M
**Автобус — пассажиры.**
**Мама — дети.**
**Страна — города.**

Связь 1:1
**Страна — официальная столица.**
**Мобильный телефон — уникальный номер IMEI.**


## Композитный первичный ключ

Присмотримся повнимательнее к промежуточной таблице **directors__video_products**.

Отдельные значения в колонках `video_product_id` и `director_id` могут повторяться — так, в колонке `video_product_id` повторяется значение **6** (ссылка на фильм «Она написала убийство»); в колонке `director_id` дважды встречается единица (ссылка на режиссёра Текса Эйвери) и дважды — шестёрка (ссылка на Энтони Пуллена Шоу).

![](https://pictures.s3.yandex.net/resources/S2_153_1_1682533673.png)

А вот каждая пара значений `video_product_id` и `director_id` должна быть уникальна: нет смысла дважды давать ссылку с одного и того же фильма на одного и того же режиссёра.

**Пара значений этих полей может служить первичным ключом.**

Первичные ключи, состоящие из значений нескольких полей, называют **композитными первичными ключами**. Например, пара «режиссёр-фильм» — это композитный ключ: ведь режиссер не может снять один и тот же фильм несколько раз.

При создании связи «многие ко многим» сначала должны быть созданы записи в связываемых таблицах и только после этого — записи в промежуточной таблице.

Другим примером композитного первичного ключа может быть пара «серия-номер» паспорта. Ни серия, ни номер не обязаны быть уникальными, но в паре эти значения составляют уникальный идентификатор, определяющий документ и его владельца.