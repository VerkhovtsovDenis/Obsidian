# Изменение таблиц в БД. Ссылочная целостность

На основе всех проведённых экспериментов можно собрать базу данных из пяти связанных таблиц.

![](https://pictures.s3.yandex.net/resources/S02_234_1678067370.png)

Если база данных спроектирована идеально и в её архитектуре учтены все возможные и невозможные варианты развития проекта — можно создать таблицы и больше к ним не возвращаться.

Однако в реальном мире база данных — это живая структура, она может расти и изменяться вместе с проектом.

Ведь в ходе разработки или эксплуатации проекта:

- может расшириться или измениться техническое задание;
- могут появиться новые данные, ради которых придётся изменить структуру БД;
- да и вообще — всякое бывает.

В любой из перечисленных ситуаций потребуется отредактировать таблицы в БД:

- переименовать, добавить или удалить таблицы,
- переименовать, добавить или удалить столбцы в таблицах.

### Изменение таблицы: ALTER TABLE

Структуру таблиц можно изменять: можно добавлять, переименовывать или удалять колонки; таблицы можно переименовывать или удалять. Это делается командой `ALTER TABLE имя_таблицы описание_операции`.

**Переименование таблицы:**

```sql
ALTER TABLE <имя таблицы>
RENAME TO <новое имя таблицы>; 
```

**Добавление колонки:**

```sql
ALTER TABLE <название таблицы> 
ADD COLUMN <имя колонки> <тип колонки>; 
```

По умолчанию SQLite добавляет новую колонку в конец списка колонок.

**Переименование колонки:**

```sql
ALTER TABLE <название таблицы>
RENAME COLUMN <старое имя колонки>
TO <новое имя колонки>; 
```

**Удаление колонки:**

В классическом SQL сработает вот такая конструкция:

```sql
ALTER TABLE <название таблицы>
DROP COLUMN <имя колонки>; 
```

Но в SQLite удаление колонок доступно только с версии 3.35.0. Для более старых версий для удаления колонки приходится идти сложным путём:

1. Создать копию таблицы, но без той колонки, которую нужно удалить.
2. Перенести в новую таблицу информацию из исходной таблицы.
3. Удалить исходную таблицу.
4. Переименовать созданную.

Документация SQLite [даст более детальную и глубокую информацию по работе с колонками](https://www.sqlite.org/lang_altertable.html).

### Удаление таблиц

> “Aliena nobis, nostra aliis” (лат. «Чужое — нам, а наше — другим (нравится)») _Публий Сир_
> «Ежели один человек построил, другой завсегда разобрать сможет»
> Публий Сир в переводе кузнеца Степана (фильм «Формула любви»)_

Команда для удаления таблицы выглядит так:

```sql
DROP TABLE <имя таблицы>; 
```

## Ссылочная целостность данных

При удалении таблиц возникает серьёзная опасность: помимо того, что будут удалены данные, может быть нарушена **ссылочная целостность** базы. На удаляемую таблицу могут ссылаться другие таблицы; ссылки останутся, а таблицы не станет. База перестанет работать.

Удалим для эксперимента таблицу **original_titles**:

```sql
DROP TABLE original_titles; 
```

Ничего хорошего не получится: ссылка из колонки `original_title_id` таблицы **video_products** повиснет в воздухе:

![](https://pictures.s3.yandex.net/resources/S02_235_1678067517.png)

Подобная же история может случиться и при удалении колонок, и при их переименовании.

При изменении первичных и внешних ключей важно соблюдать **ссылочную целостность данных** (_referential integrity_). Основная идея в том, чтобы не было «битых», ведущих в никуда ссылок на другие таблицы.

Вот примеры нарушений целостности данных:

- **Аномалия удаления** (_deletion anomaly_): если из таблицы удалена строка, на которую ссылается внешний ключ.
- **Аномалия вставки** (_insertion anomaly_): если добавлена запись с внешним ключом, но этот внешний ключ не соответствует ни одному первичному ключу из связанной таблицы.
- **Аномалии обновления** (_update anomaly_): при изменении данных в одной строке они могут прийти в противоречие с данными из другой строки: например, изменён PK, на который ссылается FK из другой таблицы.


![[Pasted image 20250124183418.png]]

В работе с базами данных немало нюансов, и чтобы вам было проще держать их во внимании, сохраните в закладки [шпаргалку](https://code.s3.yandex.net/Python-dev/cheatsheets/028-sql-shpora/028-sql-shpora.html). В ней — коротко о том, что вы изучили в уроках последних двух тем.

---

### Задание

#### Задание 1/3
##### Описание задания
В веб-проекте администратор может снимать с публикации какие-то записи, не удаляя их из БД. За это в нашем проекте отвечает поле `is_published` в таблице `ice_cream`. А чтобы отметить, какие сорта мороженого будут показаны на главной странице проекта, а какие нет — понадобится поле `is_on_main`.

В таблицу `ice_cream` добавьте обязательные колонки `is_published` и `is_on_main` типа INTEGER, в которых будет храниться значение 0 (в Python это `False`) или 1 (в Python это `True`).

##### Подсказка
Для добавления двух колонок используйте `ALTER TABLE ... ADD COLUMN ...; ALTER TABLE ... ADD COLUMN ...;`.
##### Решение задания
```python
import sqlite3

con = sqlite3.connect('db.sqlite')
cur = con.cursor()
  
cur.executescript('''
ALTER TABLE ice_cream ADD COLUMN is_published INTEGER NOT NULL;
ALTER TABLE ice_cream ADD COLUMN is_on_main INTEGER NOT NULL;
''')
  
con.close()
```

Служебные поля с булевым значением часто называют «флагами». Фраза «поставить флаг `is_published`» будет означать «установить значение `True` в поле `is_published`».

#### Задание 2/3
##### Описание задания
В таблице `ice_cream` переименуйте колонку `description`. Новое название должно быть `specification`.

##### Подсказка
Используйте `RENAME COLUMN`.
##### Решение задания
```python
import sqlite3

con = sqlite3.connect('db.sqlite')
cur = con.cursor()

cur.executescript('''
ALTER TABLE ice_cream RENAME COLUMN description TO specification;
''')

con.close()
```

Как поле ни назови — содержимое не изменится. Мороженое forever!

#### Задание 3/3
##### Описание задания
Удалите таблицу `ice_cream` из БД.

##### Подсказка
Используйте `DROP TABLE`.
##### Решение задания
```python
import sqlite3

con = sqlite3.connect('db.sqlite')
cur = con.cursor()

cur.executescript('''
DROP TABLE ice_cream;
''')
con.close()
```

`[sarcasm mode on]` Прекрасный результат: без этой таблицы база превратилась в ненужный хлам! Усугубить ситуацию можно командой `DROP DATABASE`, но SQLite не умеет её выполнять: для удаления БД в SQLite нужно удалить файл _db.sqlite_. `[sarcasm mode off]`

Отличная работа, всё получилось. А базу восстановим: у нас копия припасена!